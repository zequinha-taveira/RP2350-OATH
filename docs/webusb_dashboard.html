<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RP2350-OATH Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #667eea;
            --secondary: #764ba2;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --dark: #1f2937;
            --light: #f3f4f6;
            --border: #e5e7eb;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        .header {
            background: white;
            border-radius: 12px;
            padding: 20px 30px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            color: var(--primary);
            font-size: 28px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
        }

        .status-connected {
            background: #d1fae5;
            color: #065f46;
        }

        .status-disconnected {
            background: #fee2e2;
            color: #991b1b;
        }

        /* Main Grid */
        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .card-header {
            font-size: 18px;
            font-weight: bold;
            color: var(--dark);
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .card-content {
            min-height: 200px;
        }

        /* Buttons */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            font-size: 14px;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(102, 126, 234, 0.3);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-success:hover {
            background: #059669;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .btn-warning {
            background: var(--warning);
            color: white;
        }

        .btn-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        /* Forms */
        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: var(--dark);
        }

        .form-control {
            width: 100%;
            padding: 10px;
            border: 2px solid var(--border);
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        /* Lists */
        .list {
            list-style: none;
            max-height: 300px;
            overflow-y: auto;
        }

        .list-item {
            padding: 12px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.2s;
        }

        .list-item:hover {
            background: var(--light);
        }

        .list-item:last-child {
            border-bottom: none;
        }

        .item-info {
            flex: 1;
        }

        .item-title {
            font-weight: 600;
            color: var(--dark);
        }

        .item-subtitle {
            font-size: 12px;
            color: #6b7280;
            margin-top: 2px;
        }

        .item-actions {
            display: flex;
            gap: 5px;
        }

        .btn-small {
            padding: 4px 8px;
            font-size: 12px;
            border-radius: 4px;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 15px;
            border-bottom: 2px solid var(--border);
        }

        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border: none;
            background: none;
            font-weight: 600;
            color: #6b7280;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }

        .tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Logs */
        .log-container {
            background: #1e1e1e;
            color: #00ff00;
            padding: 15px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 250px;
            overflow-y: auto;
            white-space: pre-wrap;
        }

        .log-entry {
            margin-bottom: 5px;
            padding: 2px 0;
        }

        .log-timestamp {
            color: #888;
        }

        .log-info { color: #60a5fa; }
        .log-success { color: #34d399; }
        .log-warning { color: #fbbf24; }
        .log-error { color: #f87171; }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }

        .stat-card {
            background: var(--light);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: var(--primary);
        }

        .stat-label {
            font-size: 12px;
            color: #6b7280;
            margin-top: 5px;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 20px;
            color: var(--dark);
        }

        .modal-footer {
            margin-top: 20px;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        /* Loading Spinner */
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--primary);
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* WebSocket Status */
        .ws-status {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            padding: 6px 12px;
            border-radius: 20px;
            background: var(--light);
        }

        .ws-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #9ca3af;
        }

        .ws-indicator.connected {
            background: var(--success);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Fingerprint Animation */
        .fingerprint-icon {
            font-size: 48px;
            text-align: center;
            margin: 20px 0;
            animation: fingerprint 2s ease-in-out infinite;
        }

        @keyframes fingerprint {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.1); opacity: 0.8; }
        }

        /* Progress Bar */
        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--light);
            border-radius: 4px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: var(--primary);
            transition: width 0.3s;
        }

        /* Notification Toast */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: none;
            align-items: center;
            gap: 10px;
            z-index: 2000;
            animation: slideIn 0.3s;
        }

        .toast.show {
            display: flex;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }

        .toast.success { border-left: 4px solid var(--success); }
        .toast.error { border-left: 4px solid var(--danger); }
        .toast.warning { border-left: 4px solid var(--warning); }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>
                üîê RP2350-OATH Dashboard
            </h1>
            <div style="display: flex; gap: 15px; align-items: center;">
                <div class="ws-status">
                    <div class="ws-indicator" id="wsIndicator"></div>
                    <span id="wsStatus">Desconectado</span>
                </div>
                <div class="status-badge status-disconnected" id="deviceStatus">Desconectado</div>
            </div>
        </div>

        <!-- Main Dashboard -->
        <div class="dashboard-grid">
            <!-- Connection & Device Info -->
            <div class="card">
                <div class="card-header">
                    üì° Conex√£o
                    <div class="btn-group">
                        <button class="btn btn-primary" onclick="connectDevice()">Conectar</button>
                        <button class="btn btn-danger" onclick="disconnectDevice()" id="disconnectBtn" disabled>Desconectar</button>
                    </div>
                </div>
                <div class="card-content">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value" id="statCredentials">0</div>
                            <div class="stat-label">Credenciais</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="statBio">0</div>
                            <div class="stat-label">Biom√©tricos</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="statKeys">0</div>
                            <div class="stat-label">Chaves</div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Device Info:</label>
                        <div id="deviceInfo" style="font-size: 12px; color: #6b7280; background: var(--light); padding: 10px; border-radius: 4px;">
                            Aguardando conex√£o...
                        </div>
                    </div>
                </div>
            </div>

            <!-- WebSocket Server -->
            <div class="card">
                <div class="card-header">
                    üåê WebSocket Server
                    <div class="btn-group">
                        <button class="btn btn-success" onclick="startWebSocket()">Iniciar</button>
                        <button class="btn btn-danger" onclick="stopWebSocket()" id="wsStopBtn" disabled>Parar</button>
                    </div>
                </div>
                <div class="card-content">
                    <div class="form-group">
                        <label>Server URL:</label>
                        <input type="text" class="form-control" id="wsUrl" value="ws://localhost:8080" placeholder="ws://localhost:8080">
                    </div>
                    <div class="form-group">
                        <label>Status:</label>
                        <div id="wsServerStatus" style="padding: 10px; background: var(--light); border-radius: 4px; font-size: 12px;">
                            Servidor parado
                        </div>
                    </div>
                    <div class="btn-group">
                        <button class="btn btn-primary" onclick="testWebSocket()">Testar Conex√£o</button>
                        <button class="btn btn-warning" onclick="sendBroadcast()">Broadcast</button>
                    </div>
                </div>
            </div>

            <!-- WebUSB Crypto -->
            <div class="card">
                <div class="card-header">
                    üîë WebUSB Crypto API
                </div>
                <div class="card-content">
                    <div class="tabs">
                        <button class="tab active" onclick="switchTab('crypto', 'generate')">Gerar Chave</button>
                        <button class="tab" onclick="switchTab('crypto', 'sign')">Assinar</button>
                        <button class="tab" onclick="switchTab('crypto', 'encrypt')">Criptografar</button>
                    </div>
                    
                    <div id="crypto-generate" class="tab-content active">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Algoritmo:</label>
                                <select class="form-control" id="cryptoAlgo">
                                    <option value="ecdsa">ECDSA P-256</option>
                                    <option value="rsa">RSA-OAEP</option>
                                    <option value="aes">AES-GCM</option>
                                    <option value="hmac">HMAC-SHA256</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Tamanho:</label>
                                <input type="number" class="form-control" id="cryptoSize" value="256">
                            </div>
                        </div>
                        <button class="btn btn-primary" onclick="generateKey()">Gerar Chave</button>
                    </div>

                    <div id="crypto-sign" class="tab-content">
                        <div class="form-group">
                            <label>Dados:</label>
                            <textarea class="form-control" id="signData" rows="3" placeholder="Dados para assinar..."></textarea>
                        </div>
                        <button class="btn btn-primary" onclick="signData()">Assinar</button>
                    </div>

                    <div id="crypto-encrypt" class="tab-content">
                        <div class="form-group">
                            <label>Dados:</label>
                            <textarea class="form-control" id="encryptData" rows="3" placeholder="Dados para criptografar..."></textarea>
                        </div>
                        <button class="btn btn-primary" onclick="encryptData()">Criptografar</button>
                    </div>
                </div>
            </div>

            <!-- FIDO2 Bioenrollment -->
            <div class="card">
                <div class="card-header">
                    üë§ FIDO2 Bioenrollment
                </div>
                <div class="card-content">
                    <div class="fingerprint-icon">üëÜ</div>
                    <div class="form-group">
                        <label>Nome da Biometria:</label>
                        <input type="text" class="form-control" id="bioName" placeholder="Ex: Dedo Indicador">
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="bioProgress" style="width: 0%"></div>
                    </div>
                    <div id="bioStatus" style="font-size: 12px; color: #6b7280; text-align: center; margin: 10px 0;">
                        Pronto para enrollment
                    </div>
                    <div class="btn-group" style="justify-content: center;">
                        <button class="btn btn-success" onclick="startBioEnroll()">Iniciar Enrollment</button>
                        <button class="btn btn-danger" onclick="cancelBioEnroll()" id="bioCancelBtn" disabled>Cancelar</button>
                    </div>
                    <div class="btn-group" style="margin-top: 10px; justify-content: center;">
                        <button class="btn btn-primary" onclick="enumerateBio()">Listar Biom√©tricos</button>
                        <button class="btn btn-warning" onclick="removeBio()">Remover</button>
                    </div>
                </div>
            </div>

            <!-- CTAP2.1 Features -->
            <div class="card">
                <div class="card-header">
                    üöÄ CTAP2.1 Avan√ßado
                </div>
                <div class="card-content">
                    <div class="tabs">
                        <button class="tab active" onclick="switchTab('ctap21', 'credentials')">Credenciais</button>
                        <button class="tab" onclick="switchTab('ctap21', 'config')">Config</button>
                        <button class="tab" onclick="switchTab('ctap21', 'options')">Op√ß√µes</button>
                    </div>

                    <div id="ctap21-credentials" class="tab-content active">
                        <div class="form-group">
                            <label>RP ID:</label>
                            <input type="text" class="form-control" id="rpId" placeholder="example.com">
                        </div>
                        <div class="btn-group">
                            <button class="btn btn-primary" onclick="getCredentials()">Listar Credenciais</button>
                            <button class="btn btn-danger" onclick="deleteCredential()">Excluir</button>
                        </div>
                        <ul class="list" id="credentialsList" style="margin-top: 10px;"></ul>
                    </div>

                    <div id="ctap21-config" class="tab-content">
                        <div class="form-group">
                            <label>Comando:</label>
                            <select class="form-control" id="configCmd">
                                <option value="enterprise">Enterprise Attestation</option>
                                <option value="always_uv">Always UV</option>
                                <option value="min_pin">Min PIN Length</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Valor:</label>
                            <input type="text" class="form-control" id="configValue" placeholder="Valor">
                        </div>
                        <button class="btn btn-primary" onclick="applyConfig()">Aplicar Configura√ß√£o</button>
                    </div>

                    <div id="ctap21-options" class="tab-content">
                        <div class="form-group">
                            <label>Op√ß√µes:</label>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                <label><input type="checkbox" id="optRK"> Resident Key</label>
                                <label><input type="checkbox" id="optUV"> User Verification</label>
                                <label><input type="checkbox" id="optUP"> User Presence</label>
                                <label><input type="checkbox" id="optEnterprise"> Enterprise</label>
                            </div>
                        </div>
                        <button class="btn btn-primary" onclick="applyOptions()">Aplicar Op√ß√µes</button>
                    </div>
                </div>
            </div>

            <!-- OATH Backup & Restore -->
            <div class="card">
                <div class="card-header">
                    üíæ OATH Backup & Restore
                </div>
                <div class="card-content">
                    <div class="form-group">
                        <label>Status do Backup:</label>
                        <div id="backupStatus" style="padding: 10px; background: var(--light); border-radius: 4px; font-size: 12px;">
                            Nenhum backup realizado
                        </div>
                    </div>
                    <div class="btn-group">
                        <button class="btn btn-primary" onclick="backupOATH()">Fazer Backup</button>
                        <button class="btn btn-success" onclick="restoreOATH()">Restaurar Backup</button>
                    </div>
                </div>
            </div>

            <!-- WebSocket Client -->
            <div class="card">
                <div class="card-header">
                    üí¨ WebSocket Client
                </div>
                <div class="card-content">
                    <div class="form-group">
                        <label>Client ID:</label>
                        <input type="text" class="form-control" id="clientId" value="web-client-001">
                    </div>
                    <div class="form-group">
                        <label>Device ID:</label>
                        <input type="text" class="form-control" id="targetDeviceId" placeholder="ID do dispositivo">
                    </div>
                    <div class="btn-group">
                        <button class="btn btn-primary" onclick="connectWebSocket()">Conectar WS</button>
                        <button class="btn btn-danger" onclick="disconnectWebSocket()" id="wsClientDisconnect" disabled>Desconectar</button>
                    </div>
                    <div class="btn-group" style="margin-top: 10px;">
                        <button class="btn btn-success" onclick="sendToDevice()">Enviar Comando</button>
                        <button class="btn btn-warning" onclick="subscribeToEvents()">Assinar Eventos</button>
                    </div>
                </div>
            </div>

            <!-- Logs -->
            <div class="card" style="grid-column: 1 / -1;">
                <div class="card-header">
                    üìã Logs de Sistema
                    <div class="btn-group">
                        <button class="btn btn-small btn-primary" onclick="clearLogs()">Limpar</button>
                        <button class="btn btn-small btn-success" onclick="exportLogs()">Exportar</button>
                    </div>
                </div>
                <div class="card-content">
                    <div class="log-container" id="logContainer">
                        <div class="log-entry">
                            <span class="log-timestamp">[00:00:00]</span> <span class="log-info">Sistema iniciado. Aguardando conex√£o...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div class="toast" id="toast">
        <span id="toastMessage"></span>
    </div>

    <!-- Modal -->
    <div class="modal" id="modal">
        <div class="modal-content">
            <div class="modal-header" id="modalTitle">Modal</div>
            <div id="modalBody"></div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="closeModal()">Fechar</button>
            </div>
        </div>
    </div>

    <script>
        // Global State
        let device = null;
        let webusbInterface = null;
        let wsClient = null;
        let wsServer = null;
        let isConnected = false;
        let bioEnrollActive = false;
        let cryptoKeys = [];

        // Logging System
        function addLog(message, type = 'info') {
            const logContainer = document.getElementById('logContainer');
            const timestamp = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            entry.innerHTML = `<span class="log-timestamp">[${timestamp}]</span> ${message}`;
            logContainer.appendChild(entry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        function clearLogs() {
            document.getElementById('logContainer').innerHTML = '';
            addLog('Logs limpos', 'info');
        }

        function exportLogs() {
            const logs = document.getElementById('logContainer').innerText;
            const blob = new Blob([logs], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `rp2350-logs-${Date.now()}.txt`;
            a.click();
            showToast('Logs exportados com sucesso', 'success');
        }

        // Toast Notifications
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toastMessage');
            
            toastMessage.textContent = message;
            toast.className = `toast ${type} show`;
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // Modal
        function showModal(title, content) {
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalBody').innerHTML = content;
            document.getElementById('modal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('modal').classList.remove('active');
        }

        // Tab Switching
        function switchTab(category, tab) {
            // Remove active from all tabs in category
            document.querySelectorAll(`#${category}-${tab}`).forEach(el => {
                if (el.classList.contains('tab-content')) {
                    el.classList.remove('active');
                }
            });
            
            // Hide all tab contents
            document.querySelectorAll(`.tab-content`).forEach(el => {
                if (el.id.startsWith(category + '-')) {
                    el.classList.remove('active');
                }
            });
            
            // Show selected tab content
            const target = document.getElementById(`${category}-${tab}`);
            if (target) {
                target.classList.add('active');
            }
            
            // Update tab buttons
            const buttons = document.querySelectorAll(`.tab`);
            buttons.forEach(btn => {
                if (btn.textContent.toLowerCase().includes(tab.replace('_', ' '))) {
                    btn.classList.add('active');
                } else if (btn.onclick && btn.onclick.toString().includes(category)) {
                    btn.classList.remove('active');
                }
            });
        }

        // WebUSB Functions
        async function connectDevice() {
            try {
                addLog('Solicitando dispositivo WebUSB...', 'info');
                
                const device = await navigator.usb.requestDevice({
                    filters: [{ vendorId: 0x1050, productId: 0x0407 }] // Yubico VID/PID
                });
                
                if (!device) {
                    addLog('Nenhum dispositivo selecionado', 'error');
                    return;
                }
                
                await device.open();
                await device.selectConfiguration(1);
                await device.claimInterface(1); // WebUSB Interface
                
                window.device = device;
                isConnected = true;
                
                updateConnectionStatus(true);
                addLog('Dispositivo conectado com sucesso!', 'success');
                showToast('Dispositivo conectado', 'success');
                
                // Update stats
                updateStats();
                
            } catch (error) {
                addLog(`Erro ao conectar: ${error.message}`, 'error');
                showToast(`Erro: ${error.message}`, 'error');
            }
        }

        async function disconnectDevice() {
            if (window.device) {
                try {
                    await window.device.close();
                    window.device = null;
                    isConnected = false;
                    updateConnectionStatus(false);
                    addLog('Dispositivo desconectado', 'warning');
                    showToast('Dispositivo desconectado', 'warning');
                } catch (error) {
                    addLog(`Erro ao desconectar: ${error.message}`, 'error');
                }
            }
        }

        function updateConnectionStatus(connected) {
            const statusBadge = document.getElementById('deviceStatus');
            const disconnectBtn = document.getElementById('disconnectBtn');
            
            if (connected) {
                statusBadge.textContent = 'Conectado';
                statusBadge.className = 'status-badge status-connected';
                disconnectBtn.disabled = false;
            } else {
                statusBadge.textContent = 'Desconectado';
                statusBadge.className = 'status-badge status-disconnected';
                disconnectBtn.disabled = true;
            }
        }

        function updateStats() {
            document.getElementById('statCredentials').textContent = cryptoKeys.length;
            document.getElementById('statBio').textContent = bioEnrollActive ? '1' : '0';
            document.getElementById('statKeys').textContent = cryptoKeys.length;
        }

        // WebUSB Crypto Functions
        async function generateKey() {
            if (!isConnected) {
                showToast('Dispositivo n√£o conectado', 'error');
                return;
            }

            const algo = document.getElementById('cryptoAlgo').value;
            const size = parseInt(document.getElementById('cryptoSize').value);
            
            addLog(`Gerando chave: ${algo} (${size} bits)`, 'info');
            
            try {
                // Simulate crypto operation
                const keyId = cryptoKeys.length;
                const key = {
                    id: keyId,
                    type: algo,
                    size: size,
                    generated: new Date().toISOString()
                };
                
                cryptoKeys.push(key);
                updateStats();
                
                addLog(`Chave gerada: ID ${keyId}`, 'success');
                showToast(`Chave ${algo} gerada`, 'success');
                
                // Show key details
                showModal('Chave Gerada', `
                    <div style="font-family: monospace; background: #f5f5f5; padding: 10px; border-radius: 4px;">
                        <strong>ID:</strong> ${keyId}<br>
                        <strong>Tipo:</strong> ${key.type}<br>
                        <strong>Tamanho:</strong> ${key.size} bits<br>
                        <strong>Gerada:</strong> ${key.generated}
                    </div>
                `);
                
            } catch (error) {
                addLog(`Erro ao gerar chave: ${error.message}`, 'error');
                showToast('Erro ao gerar chave', 'error');
            }
        }

        async function signData() {
            if (!isConnected) {
                showToast('Dispositivo n√£o conectado', 'error');
                return;
            }

            const data = document.getElementById('signData').value;
            if (!data) {
                showToast('Dados vazios', 'warning');
                return;
            }

            addLog(`Assinando dados: "${data.substring(0, 30)}..."`, 'info');
            
            // Simulate signing
            setTimeout(() => {
                const signature = Array.from({length: 64}, () => 
                    Math.floor(Math.random() * 256).toString(16).padStart(2, '0')
                ).join('');
                
                addLog(`Assinatura gerada: ${signature.substring(0, 32)}...`, 'success');
                showToast('Dados assinados', 'success');
                
                showModal('Assinatura', `
                    <div style="word-break: break-all; font-family: monospace; background: #f5f5f5; padding: 10px; border-radius: 4px;">
                        ${signature}
                    </div>
                `);
            }, 500);
        }

        async function encryptData() {
            if (!isConnected) {
                showToast('Dispositivo n√£o conectado', 'error');
                return;
            }

            const data = document.getElementById('encryptData').value;
            if (!data) {
                showToast('Dados vazios', 'warning');
                return;
            }

            addLog(`Criptografando dados...`, 'info');
            
            // Simulate encryption
            setTimeout(() => {
                const encrypted = btoa(data).substring(0, 32) + '...';
                addLog(`Dados criptografados: ${encrypted}`, 'success');
                showToast('Dados criptografados', 'success');
                
                showModal('Criptografia', `
                    <div style="word-break: break-all; font-family: monospace; background: #f5f5f5; padding: 10px; border-radius: 4px;">
                        <strong>Original:</strong> ${data}<br>
                        <strong>Criptografado:</strong> ${encrypted}
                    </div>
                `);
            }, 500);
        }

        // FIDO2 Bioenrollment Functions
        function startBioEnroll() {
            const name = document.getElementById('bioName').value;
            if (!name) {
                showToast('Digite um nome para a biometria', 'warning');
                return;
            }

            addLog(`Iniciando enrollment biom√©trico: ${name}`, 'info');
            bioEnrollActive = true;
            
            const progress = document.getElementById('bioProgress');
            const status = document.getElementById('bioStatus');
            const cancelBtn = document.getElementById('bioCancelBtn');
            
            cancelBtn.disabled = false;
            status.textContent = 'Aguardando amostra... Toque no sensor';
            
            // Simulate enrollment process
            let step = 0;
            const steps = ['Aguardando amostra...', 'Processando amostra 1...', 'Processando amostra 2...', 'Processando amostra 3...', 'Finalizando...'];
            
            const interval = setInterval(() => {
                if (step < steps.length) {
                    progress.style.width = `${(step + 1) * 20}%`;
                    status.textContent = steps[step];
                    addLog(`Enrollment: ${steps[step]}`, 'info');
                    step++;
                } else {
                    clearInterval(interval);
                    bioEnrollActive = false;
                    cancelBtn.disabled = true;
                    status.textContent = 'Enrollment conclu√≠do!';
                    progress.style.width = '100%';
                    addLog(`Enrollment conclu√≠do: ${name}`, 'success');
                    showToast('Biometria cadastrada', 'success');
                    updateStats();
                }
            }, 800);
            
            // Store interval for cancellation
            window.bioInterval = interval;
        }

        function cancelBioEnroll() {
            if (window.bioInterval) {
                clearInterval(window.bioInterval);
                bioEnrollActive = false;
                document.getElementById('bioProgress').style.width = '0%';
                document.getElementById('bioStatus').textContent = 'Enrollment cancelado';
                document.getElementById('bioCancelBtn').disabled = true;
                addLog('Enrollment cancelado', 'warning');
                showToast('Opera√ß√£o cancelada', 'warning');
            }
        }

        function enumerateBio() {
            addLog('Enumerando credenciais biom√©tricas...', 'info');
            
            // Simulate enumeration
            const credentials = [
                { id: '01', name: 'Dedo Indicador', quality: 95 },
                { id: '02', name: 'Dedo Polegar', quality: 92 }
            ];
            
            const listHtml = credentials.map(c => `
                <li class="list-item">
                    <div class="item-info">
                        <div class="item-title">${c.name}</div>
                        <div class="item-subtitle">Qualidade: ${c.quality}%</div>
                    </div>
                    <div class="item-actions">
                        <button class="btn btn-small btn-danger" onclick="removeBioId('${c.id}')">Remover</button>
                    </div>
                </li>
            `).join('');
            
            showModal('Credenciais Biom√©tricas', `
                <ul class="list">${listHtml}</ul>
            `);
            
            addLog(`Encontradas ${credentials.length} credenciais`, 'success');
        }

        function removeBio() {
            const name = document.getElementById('bioName').value;
            if (!name) {
                showToast('Selecione uma biometria para remover', 'warning');
                return;
            }
            
            addLog(`Removendo biometria: ${name}`, 'warning');
            
            setTimeout(() => {
                addLog('Biometria removida com sucesso', 'success');
                showToast('Biometria removida', 'success');
            }, 500);
        }

        function removeBioId(id) {
            addLog(`Removendo biometria ID: ${id}`, 'warning');
            showToast(`Biometria ${id} removida`, 'success');
            closeModal();
        }

        // CTAP2.1 Functions
        function getCredentials() {
            const rpId = document.getElementById('rpId').value;
            if (!rpId) {
                showToast('Digite um RP ID', 'warning');
                return;
            }
            
            addLog(`Listando credenciais para: ${rpId}`, 'info');
            
            // Simulate credential retrieval
            const credentials = [
                { id: 'cred_001', user: 'user@example.com', type: 'ES256' },
                { id: 'cred_002', user: 'admin@company.com', type: 'RS256' }
            ];
            
            const listHtml = credentials.map(c => `
                <li class="list-item">
                    <div class="item-info">
                        <div class="item-title">${c.user}</div>
                        <div class="item-subtitle">ID: ${c.id} | Algoritmo: ${c.type}</div>
                    </div>
                    <div class="item-actions">
                        <button class="btn btn-small btn-danger" onclick="deleteCred('${c.id}')">Excluir</button>
                    </div>
                </li>
            `).join('');
            
            document.getElementById('credentialsList').innerHTML = listHtml;
            addLog(`Encontradas ${credentials.length} credenciais`, 'success');
        }

        function deleteCredential() {
            const rpId = document.getElementById('rpId').value;
            if (!rpId) {
                showToast('Digite um RP ID', 'warning');
                return;
            }
            
            addLog(`Excluindo credenciais de: ${rpId}`, 'warning');
            
            setTimeout(() => {
                addLog('Credenciais exclu√≠das', 'success');
                showToast('Credenciais exclu√≠das', 'success');
                document.getElementById('credentialsList').innerHTML = '';
            }, 500);
        }

        function deleteCred(id) {
            addLog(`Excluindo credencial: ${id}`, 'warning');
            showToast(`Credencial ${id} exclu√≠da`, 'success');
            getCredentials(); // Refresh list
        }

        function applyConfig() {
            const cmd = document.getElementById('configCmd').value;
            const value = document.getElementById('configValue').value;
            
            if (!value) {
                showToast('Digite um valor', 'warning');
                return;
            }
            
            addLog(`Aplicando configura√ß√£o ${cmd}: ${value}`, 'info');
            
            setTimeout(() => {
                addLog('Configura√ß√£o aplicada', 'success');
                showToast('Configura√ß√£o aplicada', 'success');
            }, 500);
        }

        function applyOptions() {
            const options = {
                rk: document.getElementById('optRK').checked,
                uv: document.getElementById('optUV').checked,
                up: document.getElementById('optUP').checked,
                enterprise: document.getElementById('optEnterprise').checked
            };
            
            addLog(`Aplicando op√ß√µes: ${JSON.stringify(options)}`, 'info');
            
            setTimeout(() => {
                addLog('Op√ß√µes aplicadas', 'success');
                showToast('Op√ß√µes aplicadas', 'success');
            }, 500);
        }

        // WebSocket Functions
        function startWebSocket() {
            const url = document.getElementById('wsUrl').value;
            addLog(`Iniciando servidor WebSocket em ${url}`, 'info');
            
            // In production, this would start a Node.js server
            // For demo, we simulate server status
            document.getElementById('wsServerStatus').textContent = `Servidor rodando em ${url}`;
            document.getElementById('wsStopBtn').disabled = false;
            
            addLog('Servidor WebSocket iniciado', 'success');
            showToast('Servidor iniciado', 'success');
            
            // Update indicator
            document.getElementById('wsIndicator').classList.add('connected');
            document.getElementById('wsStatus').textContent = 'Conectado';
        }

        function stopWebSocket() {
            addLog('Parando servidor WebSocket...', 'warning');
            document.getElementById('wsServerStatus').textContent = 'Servidor parado';
            document.getElementById('wsStopBtn').disabled = true;
            document.getElementById('wsIndicator').classList.remove('connected');
            document.getElementById('wsStatus').textContent = 'Desconectado';
            showToast('Servidor parado', 'warning');
        }

        function testWebSocket() {
            addLog('Testando conex√£o WebSocket...', 'info');
            
            // Simulate test
            setTimeout(() => {
                addLog('Conex√£o WebSocket OK', 'success');
                showToast('WebSocket funcionando', 'success');
            }, 500);
        }

        function sendBroadcast() {
            const message = prompt('Mensagem para broadcast:');
            if (message) {
                addLog(`Broadcast: ${message}`, 'info');
                showToast('Mensagem enviada', 'success');
            }
        }

        function connectWebSocket() {
            const clientId = document.getElementById('clientId').value;
            const url = document.getElementById('wsUrl').value;
            
            addLog(`Conectando WebSocket: ${clientId}`, 'info');
            
            try {
                // Simulate WebSocket connection
                wsClient = { connected: true, clientId };
                
                document.getElementById('wsClientDisconnect').disabled = false;
                addLog('WebSocket conectado', 'success');
                showToast('Conectado ao servidor', 'success');
            } catch (error) {
                addLog(`Erro WebSocket: ${error.message}`, 'error');
                showToast('Erro ao conectar', 'error');
            }
        }

        function disconnectWebSocket() {
            if (wsClient) {
                wsClient = null;
                document.getElementById('wsClientDisconnect').disabled = true;
                addLog('WebSocket desconectado', 'warning');
                showToast('Desconectado', 'warning');
            }
        }

        function sendToDevice() {
            const deviceId = document.getElementById('targetDeviceId').value;
            if (!deviceId) {
                showToast('Digite o ID do dispositivo', 'warning');
                return;
            }
            
            const command = prompt('Comando para enviar:');
            if (command) {
                addLog(`Enviando para ${deviceId}: ${command}`, 'info');
                showToast('Comando enviado', 'success');
            }
        }

        function subscribeToEvents() {
            const deviceId = document.getElementById('targetDeviceId').value;
            if (!deviceId) {
                showToast('Digite o ID do dispositivo', 'warning');
                return;
            }
            
            addLog(`Assinando eventos de: ${deviceId}`, 'info');
            showToast('Assinatura realizada', 'success');
        }

        // OATH Backup/Restore
        async function backupOATH() {
            if (!isConnected) {
                showToast('Dispositivo n√£o conectado', 'error');
                return;
            }

            addLog('Iniciando backup das credenciais OATH...', 'info');
            
            try {
                // Command: 0x20 (WEBUSB_CMD_OATH_BACKUP)
                const data = new Uint8Array([0x20]);
                await window.device.transferOut(2, data);
                
                const result = await window.device.transferIn(1, 8192);
                if (result.data.getUint8(0) === 0x20 && result.data.getUint8(1) === 0x00) {
                    const backupBlob = result.data.buffer.slice(2);
                    const blob = new Blob([backupBlob], { type: 'application/octet-stream' });
                    const url = URL.createObjectURL(blob);
                    
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `rp2350-oath-backup-${Date.now()}.bin`;
                    a.click();
                    
                    document.getElementById('backupStatus').textContent = `Backup conclu√≠do: ${backupBlob.byteLength} bytes`;
                    addLog(`Backup conclu√≠do com sucesso (${backupBlob.byteLength} bytes)`, 'success');
                    showToast('Backup realizado', 'success');
                } else {
                    addLog('Falha no backup: Resposta inv√°lida do dispositivo', 'error');
                    showToast('Falha no backup', 'error');
                }
            } catch (error) {
                addLog(`Erro no backup: ${error.message}`, 'error');
                showToast('Erro no backup', 'error');
            }
        }

        async function restoreOATH() {
            if (!isConnected) {
                showToast('Dispositivo n√£o conectado', 'error');
                return;
            }

            const input = document.createElement('input');
            input.type = 'file';
            input.onchange = async (e) => {
                const file = e.target.files[0];
                if (!file) return;

                addLog(`Restaurando backup: ${file.name}...`, 'info');
                const buffer = await file.arrayBuffer();
                const data = new Uint8Array(buffer.byteLength + 1);
                data[0] = 0x21; // WEBUSB_CMD_OATH_RESTORE
                data.set(new Uint8Array(buffer), 1);

                try {
                    await window.device.transferOut(2, data);
                    const result = await window.device.transferIn(1, 64);
                    
                    if (result.data.getUint8(0) === 0x21 && result.data.getUint8(1) === 0x00) {
                        addLog('Backup restaurado com sucesso!', 'success');
                        showToast('Backup restaurado', 'success');
                        updateStats();
                    } else {
                        addLog('Falha ao restaurar: Resposta inv√°lida', 'error');
                        showToast('Falha ao restaurar', 'error');
                    }
                } catch (error) {
                    addLog(`Erro ao restaurar: ${error.message}`, 'error');
                    showToast('Erro ao restaurar', 'error');
                }
            };
            input.click();
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            addLog('Dashboard inicializado com sucesso', 'success');
            addLog('Aguardando conex√£o do dispositivo RP2350-OATH', 'info');
        });
    </script>
</body>
</html>